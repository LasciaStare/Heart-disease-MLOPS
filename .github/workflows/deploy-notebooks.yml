name: Deploy Notebooks with Jupyter Book

# Ejecutar en push a main
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permitir ejecución manual

# Permisos necesarios para GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Evitar despliegues concurrentes
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del código
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # 2. Configurar Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # 3. Instalar Jupyter Book y dependencias
      - name: Install Jupyter Book and Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyter-book matplotlib seaborn pandas numpy scikit-learn joblib
      
      # 4. Crear estructura de Jupyter Book
      - name: Create Jupyter Book Structure
        run: |
          rm -rf book
          mkdir -p book
          cp notebooks/*.ipynb book/

          # Copiar dataset si existe, pero dentro de una carpeta dedicada
          if [ -f notebooks/heart.csv ]; then
            mkdir -p book/data
            cp notebooks/heart.csv book/data/
          fi

          cp logo.png book/
          
          # Crear _config.yml
          cat > book/_config.yml << 'EOF'
          title: Heart Disease Prediction - MLOps
          author: Jose Menco, Iván Ramirez, Camilo Vargas
          logo: logo.png
          
          execute:
            execute_notebooks: "off"  # No ejecutar notebooks (ya tienen outputs)
          
          html:
            use_repository_button: true
            use_issues_button: true
            home_page_in_navbar: false
          
          repository:
            url: https://github.com/${{ github.repository }}
            branch: main
          
          sphinx:
            config:
              html_theme: sphinx_book_theme
              html_theme_options:
                repository_url: https://github.com/${{ github.repository }}
                use_repository_button: true
          EOF
          
          # Crear _toc.yml (Table of Contents)
          cat > book/_toc.yml << 'EOF'
          format: jb-book
          root: intro
          chapters:
            - file: 1_model_leakage_demo
              title: "1. Data Leakage Demonstration"
            - file: 2_model_pipeline_cv
              title: "2. Model Training Pipeline"
          EOF
          
          # Crear intro.md
          cat > book/intro.md << 'EOF'
          # Heart Disease Prediction - MLOps Project
          
          ## Descripción
          
          Este proyecto implementa un pipeline completo de **Machine Learning Operations (MLOps)** para entrenar, desplegar y servir un modelo de clasificación que predice el riesgo de enfermedad cardíaca.
          
          ## Notebooks Disponibles
          
          ### 1. Data Leakage Demonstration
          Análisis exploratorio y demostración del impacto del data leakage en el rendimiento de modelos de ML.
          
          ### 2. Model Training Pipeline  
          Pipeline de entrenamiento con GridSearchCV, optimización de hiperparámetros y selección del mejor modelo basado en Recall.
          
          ## Resultados del Modelo
          
          | Métrica | Valor |
          |---------|-------|
          | **Recall** | 91.18% |
          | **AUC** | 0.9397 |
          | **Accuracy** | 89.67% |
          | **Precision** | 90.29% |
          | **F1-Score** | 90.73% |
          
          ## Dataset
          
          - **Tamaño**: 918 pacientes
          - **Features**: 12 variables clínicas
          - **Target**: HeartDisease (0 = No, 1 = Sí)
          - **Split**: 80% train / 20% test
          
          ## Autores
          
          - Jose Menco
          - Iván Ramirez
          - Camilo Vargas
          EOF
      
      # 5. Construir Jupyter Book
      - name: Build Jupyter Book
        run: |
          cd book
          jupyter-book build .
          
          # Verificar que se creó el directorio de salida
          if [ ! -d "_build/html" ]; then
            echo "Error: book/_build/html no fue creado"
            exit 1
          fi
          
          echo "✓ Jupyter Book construido exitosamente"
          ls -la _build/html
      
      # 6. Configurar GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      # 7. Subir artefacto para Pages
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: book/_build/html
      
      # 8. Desplegar a GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      # 9. Mostrar URL de despliegue
      - name: Display Deployment URL
        run: |
          echo "✓ Notebooks desplegados exitosamente!"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
