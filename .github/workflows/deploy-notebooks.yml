name: Deploy Notebooks with Jupyter Book

on:
  push:
    branches: [main]

env:
  BASE_URL: /${{ github.event.repository.name }}

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v3
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18.x
      
      - name: Install Jupyter Book (via myst)
        run: npm install -g jupyter-book
      
      - name: Create Book Structure
        run: |
          mkdir -p notebooks
          cp notebooks/*.ipynb notebooks/ 2>/dev/null || true
          cp logo.png notebooks/ 2>/dev/null || true
          
          cat > notebooks/_config.yml << 'EOF'
          title: Heart Disease Prediction - MLOps
          author: Jose Menco, Iván Ramirez, Camilo Vargas
          logo: logo.png
          
          execute:
            execute_notebooks: "off"
          
          html:
            use_repository_button: true
            use_issues_button: true
            home_page_in_navbar: false
          
          repository:
            url: https://github.com/${{ github.repository }}
            branch: main
          EOF
          
          cat > notebooks/_toc.yml << 'EOF'
          format: jb-book
          root: intro
          chapters:
            - file: 1_model_leakage_demo
              title: "1. Data Leakage Demonstration"
            - file: 2_model_pipeline_cv
              title: "2. Model Training Pipeline"
          EOF
          
          cat > notebooks/intro.md << 'EOF'
          # Heart Disease Prediction - MLOps Project
          
          ## Descripción
          
          Este proyecto implementa un pipeline completo de **Machine Learning Operations (MLOps)** para entrenar, desplegar y servir un modelo de clasificación que predice el riesgo de enfermedad cardíaca.
          
          ## Notebooks Disponibles
          
          ### 1. Data Leakage Demonstration
          Análisis exploratorio y demostración del impacto del data leakage en el rendimiento de modelos de ML.
          
          ### 2. Model Training Pipeline  
          Pipeline de entrenamiento con GridSearchCV, optimización de hiperparámetros y selección del mejor modelo basado en Recall.
          
          ## Resultados del Modelo
          
          | Métrica | Valor |
          |---------|-------|
          | **Recall** | 91.18% |
          | **AUC** | 0.9397 |
          | **Accuracy** | 89.67% |
          | **Precision** | 90.29% |
          | **F1-Score** | 90.73% |
          
          ## Dataset
          
          - **Tamaño**: 918 pacientes
          - **Features**: 12 variables clínicas
          - **Target**: HeartDisease (0 = No, 1 = Sí)
          - **Split**: 80% train / 20% test
          
          ## Autores
          
          - Jose Menco
          - Iván Ramirez
          - Camilo Vargas
          EOF
      
      - name: Build HTML Assets
        run: |
          cd notebooks
          jupyter-book build --html
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'notebooks/_build/html'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
